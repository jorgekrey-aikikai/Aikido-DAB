<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aikido Techniken Lernkarten</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            padding-bottom: 80px;
        }

        .header {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-btn {
            padding: 10px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            min-width: 80px;
        }

        .filter-btn.active {
            border-color: currentColor;
            background: currentColor;
            color: white;
        }

        .filter-btn.gelb { color: #FDB813; }
        .filter-btn.orange { color: #FF8C00; }
        .filter-btn.gruen { color: #2E7D32; }
        .filter-btn.blau { color: #1976D2; }
        .filter-btn.braun { color: #5D4037; }
        .filter-btn.alle { color: #666; }

        .stats {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .mode-btn:active {
            transform: scale(0.95);
        }

        .mode-btn.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .exam-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .exam-overlay.active {
            display: flex;
        }

        .exam-result {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
        }

        .exam-result h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .exam-score {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .exam-score.excellent { color: #2E7D32; }
        .exam-score.good { color: #FF8C00; }
        .exam-score.poor { color: #D32F2F; }

        .exam-detail {
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .exam-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
        }

        .last-practiced {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .last-practiced.rusty {
            color: #D32F2F;
            font-weight: 600;
        }

        .card {
            background: white;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            padding: 15px;
            cursor: pointer;
            user-select: none;
            position: relative;
            border-left: 4px solid;
        }

        .card-header.gelb { border-left-color: #FDB813; }
        .card-header.orange { border-left-color: #FF8C00; }
        .card-header.gruen { border-left-color: #2E7D32; }
        .card-header.blau { border-left-color: #1976D2; }
        .card-header.braun { border-left-color: #5D4037; }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 0.9em;
            color: #666;
        }

        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .card.expanded .card-content {
            max-height: 1000px;
        }

        .card-body {
            padding: 15px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }

        .info-row {
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .info-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 0.95em;
            color: #333;
        }

        .video-links {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .video-btn {
            flex: 1;
            padding: 10px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .video-btn:active {
            background: #1565C0;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .status-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .status-btn.kann-ich {
            border-color: #2E7D32;
            color: #2E7D32;
        }

        .status-btn.kann-ich.active {
            background: #2E7D32;
            color: white;
        }

        .status-btn.geht-so {
            border-color: #FF8C00;
            color: #FF8C00;
        }

        .status-btn.geht-so.active {
            background: #FF8C00;
            color: white;
        }

        .status-btn.katastrophe {
            border-color: #D32F2F;
            color: #D32F2F;
        }

        .status-btn.katastrophe.active {
            background: #D32F2F;
            color: white;
        }

        .expand-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: #999;
            transition: transform 0.3s;
        }

        .card.expanded .expand-indicator {
            transform: translateY(-50%) rotate(180deg);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        @media (max-width: 600px) {
            .filter-btn {
                font-size: 0.85em;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Aikido Techniken</h1>
        <div class="filter-bar" id="filterBar"></div>
        <div class="mode-buttons">
            <button class="mode-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ Shuffle</button>
            <button class="mode-btn" id="examBtn" onclick="toggleExamMode()">üìù Pr√ºfung</button>
        </div>
        <input type="file" id="csvUpload" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">
        <div class="stats" id="stats"></div>
    </div>

    <div id="cardContainer"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
        Keine Techniken gefunden
    </div>

    <div class="exam-overlay" id="examOverlay">
        <div class="exam-result">
            <h2>Pr√ºfungsergebnis</h2>
            <div class="exam-score" id="examScore"></div>
            <div class="exam-detail" id="examDetail"></div>
            <button class="exam-btn" onclick="closeExam()">Zur√ºck zum Training</button>
        </div>
    </div>

    <script>
        let techniques = [];
        let currentFilter = 'alle';
        let userProgress = {};
        let practiceHistory = {};
        let shuffleMode = false;
        let examMode = false;
        let examStartTime = null;

        // Farben-Mapping
        const colorMap = {
            'Gelb (5. Kyu)': 'gelb',
            'Orange (4. Kyu)': 'orange',
            'Gr√ºn (3. Kyu)': 'gruen',
            'Blau (2. Kyu)': 'blau',
            'Braun (1. Kyu)': 'braun'
        };

        // Lokalen Speicher laden
        function loadProgress() {
            const saved = localStorage.getItem('aikidoProgress');
            if (saved) {
                userProgress = JSON.parse(saved);
            }
            const history = localStorage.getItem('aikidoHistory');
            if (history) {
                practiceHistory = JSON.parse(history);
            }
        }

        // Lokalen Speicher speichern
        function saveProgress() {
            localStorage.setItem('aikidoProgress', JSON.stringify(userProgress));
            localStorage.setItem('aikidoHistory', JSON.stringify(practiceHistory));
        }

        // CSV laden und parsen
        async function loadData() {
            try {
                const response = await fetch('techniken.csv');
                const text = await response.text();
                parseCSV(text);
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // CSV parsen
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split('\t');
            
            techniques = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split('\t');
                if (values.length < 7) continue;

                techniques.push({
                    id: i,
                    technik: values[0]?.trim() || '',
                    variation: values[1]?.trim() || '',
                    angriffJap: values[2]?.trim() || '',
                    angriffDe: values[3]?.trim() || '',
                    farbe: values[4]?.trim() || '',
                    videoKarl: values[5]?.trim() || '',
                    videoArt: values[6]?.trim() || ''
                });
            }

            createFilterButtons();
            renderCards();
        }

        // Filter-Buttons erstellen
        function createFilterButtons() {
            const filterBar = document.getElementById('filterBar');
            const colors = [...new Set(techniques.map(t => t.farbe))].sort();
            
            let html = '<button class="filter-btn alle active" onclick="setFilter(\'alle\')">Alle</button>';
            
            colors.forEach(color => {
                const colorClass = colorMap[color] || 'alle';
                html += `<button class="filter-btn ${colorClass}" onclick="setFilter('${color}')">${color.split(' ')[0]}</button>`;
            });
            
            filterBar.innerHTML = html;
        }

        // Filter setzen
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCards();
        }

        // Shuffle aktivieren/deaktivieren
        function toggleShuffle() {
            shuffleMode = !shuffleMode;
            document.getElementById('shuffleBtn').classList.toggle('active', shuffleMode);
            renderCards();
        }

        // Pr√ºfungsmodus aktivieren/deaktivieren
        function toggleExamMode() {
            examMode = !examMode;
            const btn = document.getElementById('examBtn');
            btn.classList.toggle('active', examMode);
            
            if (examMode) {
                examStartTime = Date.now();
                shuffleMode = true;
                document.getElementById('shuffleBtn').classList.add('active');
                btn.textContent = '‚úì Pr√ºfung beenden';
            } else {
                showExamResults();
                btn.textContent = 'üìù Pr√ºfung';
            }
            renderCards();
        }

        // Pr√ºfungsergebnisse anzeigen
        function showExamResults() {
            const filtered = currentFilter === 'alle' 
                ? techniques 
                : techniques.filter(t => t.farbe === currentFilter);
            
            const total = filtered.length;
            const kannIch = filtered.filter(t => userProgress[t.id] === 'kann-ich').length;
            const gehtSo = filtered.filter(t => userProgress[t.id] === 'geht-so').length;
            const katastrophe = filtered.filter(t => userProgress[t.id] === 'katastrophe').length;
            const unbewertet = total - kannIch - gehtSo - katastrophe;
            
            const percentage = total > 0 ? Math.round((kannIch / total) * 100) : 0;
            
            const overlay = document.getElementById('examOverlay');
            const score = document.getElementById('examScore');
            const detail = document.getElementById('examDetail');
            
            score.textContent = percentage + '%';
            score.className = 'exam-score ' + 
                (percentage >= 80 ? 'excellent' : percentage >= 60 ? 'good' : 'poor');
            
            detail.innerHTML = `
                <strong>${kannIch} von ${total} Techniken beherrscht</strong><br><br>
                ‚úì Kann ich: ${kannIch}<br>
                ~ Geht so: ${gehtSo}<br>
                ‚úó Katastrophe: ${katastrophe}<br>
                ${unbewertet > 0 ? `‚äò Nicht bewertet: ${unbewertet}` : ''}
            `;
            
            overlay.classList.add('active');
        }

        // Pr√ºfung schlie√üen
        function closeExam() {
            document.getElementById('examOverlay').classList.remove('active');
        }

        // CSV Upload Handler
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
                alert('CSV erfolgreich aktualisiert! ' + techniques.length + ' Techniken geladen.');
            };
            reader.readAsText(file);
        }

        // Shuffle Array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Zeitdifferenz berechnen
        function getDaysSince(timestamp) {
            if (!timestamp) return null;
            const days = Math.floor((Date.now() - timestamp) / (1000 * 60 * 60 * 24));
            return days;
        }

        // Letzte √úbung formatieren
        function formatLastPracticed(id) {
            const lastTime = practiceHistory[id];
            if (!lastTime) return '';
            
            const days = getDaysSince(lastTime);
            if (days === 0) return '<div class="last-practiced">Heute ge√ºbt</div>';
            if (days === 1) return '<div class="last-practiced">Gestern ge√ºbt</div>';
            
            const isRusty = days > 30;
            const className = isRusty ? 'last-practiced rusty' : 'last-practiced';
            const text = isRusty ? `‚ö†Ô∏è Seit ${days} Tagen nicht ge√ºbt!` : `Vor ${days} Tagen ge√ºbt`;
            
            return `<div class="${className}">${text}</div>`;
        }

        // Karten rendern
        function renderCards() {
            const container = document.getElementById('cardContainer');
            const emptyState = document.getElementById('emptyState');
            
            let filtered = currentFilter === 'alle' 
                ? techniques 
                : techniques.filter(t => t.farbe === currentFilter);

            if (shuffleMode) {
                filtered = shuffleArray(filtered);
            }

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                updateStats(0, 0);
                return;
            }

            emptyState.style.display = 'none';
            
            let html = '';
            filtered.forEach(tech => {
                const colorClass = colorMap[tech.farbe] || 'alle';
                const status = userProgress[tech.id] || '';
                
                const title = [tech.technik, tech.variation].filter(Boolean).join(' - ');
                const lastPracticed = formatLastPracticed(tech.id);
                
                html += `
                    <div class="card" id="card-${tech.id}">
                        <div class="card-header ${colorClass}" onclick="toggleCard(${tech.id})">
                            <div class="card-title">${title}</div>
                            <div class="card-subtitle">${tech.angriffJap}</div>
                            ${lastPracticed}
                            <span class="expand-indicator">‚ñº</span>
                        </div>
                        <div class="card-content">
                            <div class="card-body">
                                ${tech.angriffDe ? `
                                <div class="info-row">
                                    <div class="info-label">Deutsche Beschreibung</div>
                                    <div class="info-value">${tech.angriffDe}</div>
                                </div>
                                ` : ''}
                                
                                ${tech.videoKarl || tech.videoArt ? `
                                <div class="info-row">
                                    <div class="info-label">Videos</div>
                                    <div class="video-links">
                                        ${tech.videoKarl ? `<a href="${tech.videoKarl}" target="_blank" class="video-btn">Karl Ruben</a>` : ''}
                                        ${tech.videoArt ? `<a href="${tech.videoArt}" target="_blank" class="video-btn">Art of Aikido</a>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ${!examMode ? `
                            <div class="status-buttons">
                                <button class="status-btn kann-ich ${status === 'kann-ich' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'kann-ich')">‚úì Kann ich</button>
                                <button class="status-btn geht-so ${status === 'geht-so' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'geht-so')">~ Geht so</button>
                                <button class="status-btn katastrophe ${status === 'katastrophe' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'katastrophe')">‚úó Katastrophe</button>
                            </div>
                            ` : `
                            <div class="status-buttons">
                                <button class="status-btn kann-ich ${status === 'kann-ich' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'kann-ich')">‚úì</button>
                                <button class="status-btn geht-so ${status === 'geht-so' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'geht-so')">~</button>
                                <button class="status-btn katastrophe ${status === 'katastrophe' ? 'active' : ''}" 
                                        onclick="setStatus(${tech.id}, 'katastrophe')">‚úó</button>
                            </div>
                            `}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStats(filtered.length, techniques.length);
        }

        // Karte auf-/zuklappen
        function toggleCard(id) {
            const card = document.getElementById(`card-${id}`);
            card.classList.toggle('expanded');
        }

        // Status setzen
        function setStatus(id, status) {
            event.stopPropagation();
            
            if (userProgress[id] === status) {
                delete userProgress[id];
            } else {
                userProgress[id] = status;
                practiceHistory[id] = Date.now();
            }
            
            saveProgress();
            renderCards();
        }

        // Statistik aktualisieren
        function updateStats(shown, total) {
            const stats = document.getElementById('stats');
            const kannIch = Object.values(userProgress).filter(s => s === 'kann-ich').length;
            const gehtSo = Object.values(userProgress).filter(s => s === 'geht-so').length;
            const katastrophe = Object.values(userProgress).filter(s => s === 'katastrophe').length;
            
            stats.innerHTML = `
                ${shown} von ${total} Techniken | 
                <span style="color: #2E7D32">‚úì ${kannIch}</span> | 
                <span style="color: #FF8C00">~ ${gehtSo}</span> | 
                <span style="color: #D32F2F">‚úó ${katastrophe}</span>
            `;
        }

        // Init
        loadProgress();
        loadData();

        // Admin-Zugang: 5x auf Titel klicken aktiviert CSV-Upload
        let adminClicks = 0;
        let adminTimeout;
        document.querySelector('h1').addEventListener('click', function() {
            adminClicks++;
            clearTimeout(adminTimeout);
            
            if (adminClicks >= 5) {
                document.getElementById('csvUpload').click();
                adminClicks = 0;
            }
            
            adminTimeout = setTimeout(() => {
                adminClicks = 0;
            }, 2000);
        });
    </script>
</body>
</html>
